name: Generate and Upload SBOM

on:
  push:
    branches:
      - master
  workflow_dispatch:

jobs:
  sbom_scan:
    runs-on: ubuntu-latest

    steps:
      - name: 1. Checkout Code
        uses: 'actions/checkout@v4'

      - name: 2. Set up Flutter
        uses: 'subosito/flutter-action@v2'
        with:
          flutter-version: '3.22.x' 

      - name: 3. Manually Install Trivy
        # FIX 2: Bypasses the failing aquasecurity/setup-trivy action
        run: |
          sudo apt-get update
          sudo apt-get install -y wget
          wget https://github.com/aquasecurity/trivy/releases/download/v0.53.0/trivy_0.53.0_Linux-64bit.deb
          sudo dpkg -i trivy_0.53.0_Linux-64bit.deb
          trivy --version
          
      - name: 4. Run 'flutter pub get' to resolve dependencies
        working-directory: ./password_hygiene_coach 
        run: flutter pub get

      - name: 5. Generate CycloneDX SBOM with Vulns/Licenses
        working-directory: ./password_hygiene_coach
        run: |
          trivy fs \
            --format cyclonedx \
            --scanners vuln,license \
            --output cyclonedx-sbom.json \
            .
      
      - name: 6. Get Project Metadata (Name & Version)
        id: metadata
        run: |
          echo "PROJECT_NAME=password-hygiene-coach" >> $GITHUB_OUTPUT
          echo "PROJECT_VERSION=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT

      - name: 7. Upload SBOM to Dependency-Track
        working-directory: ./password_hygiene_coach
        run: |
          curl -X POST "${{ secrets.DT_URL }}" \
            -H "Content-Type: multipart/form-data" \
            -H "X-Api-Key: ${{ secrets.DT_API_KEY }}" \
            -F "autoCreate=true" \
            -F "projectName=${{ steps.metadata.outputs.PROJECT_NAME }}" \
            -F "projectVersion=${{ steps.metadata.outputs.PROJECT_VERSION }}" \
            -F "bom=@cyclonedx-sbom.json"
