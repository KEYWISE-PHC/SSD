name: Generate and Upload SBOM

# ----------------------------------------------------------------------
# Trigger: Run the workflow on every push to the main branch.
# ----------------------------------------------------------------------
on:
  push:
    branches:
      - master
  workflow_dispatch:

jobs:
  sbom_scan:
    runs-on: ubuntu-latest

    steps:
      - name: 1. Checkout Code
        uses: actions/checkout@v4

      - name: 2. Set up Flutter
        uses: subosito/flutter-action@48d844c80328904791e84a22c5443a505f56667a
        with:
          flutter-version: '3.19.2'

      - name: 3. Install Trivy
        # Installs the security scanner used to generate the SBOM
        run: |
          sudo apt-get update
          sudo apt-get install -y wget
          wget https://github.com/aquasecurity/trivy/releases/download/v0.53.0/trivy_0.53.0_Linux-64bit.deb
          sudo dpkg -i trivy_0.53.0_Linux-64bit.deb
          # Verify installation
          trivy --version

      - name: 4. Run 'flutter pub get' to resolve dependencies
        # This is a critical step for Trivy to find the pubspec.lock file
        run: flutter pub get

      # ----------------------------------------------------------------------
      # 5. Generate the Security-Enriched SBOM
      # ----------------------------------------------------------------------
      - name: 5. Generate CycloneDX SBOM with Vulns/Licenses
        run: |
          trivy fs \
            --format cyclonedx \
            --scanners vuln,license \
            --output cyclonedx-sbom.json \
            .
      
      # ----------------------------------------------------------------------
      # 6. Extract Project Metadata for Dependency-Track
      # ----------------------------------------------------------------------
      - name: 6. Get Project Metadata (Name & Version)
        id: metadata
        run: |
          # The PROJECT_NAME used in Dependency-Track
          echo "PROJECT_NAME=password-hygiene-coach" >> $GITHUB_OUTPUT
          # Use the short Git SHA for a unique, traceable project version
          echo "PROJECT_VERSION=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT

      # ----------------------------------------------------------------------
      # 7. Upload SBOM to Dependency-Track
      # ----------------------------------------------------------------------
      - name: 7. Upload SBOM to Dependency-Track
        # The curl command posts the SBOM file to the Dependency-Track API
        run: |
          curl -X POST "${{ secrets.DT_URL }}" \
            -H "Content-Type: multipart/form-data" \
            -H "X-Api-Key: ${{ secrets.DT_API_KEY }}" \
            -F "autoCreate=true" \
            -F "projectName=${{ steps.metadata.outputs.PROJECT_NAME }}" \
            -F "projectVersion=${{ steps.metadata.outputs.PROJECT_VERSION }}" \
            -F "bom=@cyclonedx-sbom.json"
