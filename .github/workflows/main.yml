name: Flutter Security CI/CD

on:
  push:
    branches:
      - master
  workflow_dispatch:

jobs:
  security_scan:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.38.4' 

      - name: Install Trivy
        run: |
          sudo apt-get update
          sudo apt-get install -y wget
          wget https://github.com/aquasecurity/trivy/releases/download/v0.53.0/trivy_0.53.0_Linux-64bit.deb
          sudo dpkg -i trivy_0.53.0_Linux-64bit.deb
          trivy --version

      - name: Install Dependency-Check
        run: |
          wget https://github.com/jeremylong/DependencyCheck/releases/download/v8.0.2/dependency-check-8.0.2-release.zip
          unzip dependency-check-8.0.2-release.zip -d $HOME/dependency-check
          echo "$HOME/dependency-check/bin/dependency-check.sh"

      - name: Flutter Pub Get
        working-directory: ./password_hygiene_coach
        run: flutter pub get

      - name: Generate CycloneDX SBOM
        working-directory: ./password_hygiene_coach
        run: |
          trivy fs \
            --format cyclonedx \
            --scanners vuln,license \
            --output cyclonedx-sbom.json \
            .

      # 7. Run Dependency-Check scan
      - name: Run Dependency-Check
        working-directory: ./password_hygiene_coach
        run: |
          $HOME/dependency-check/bin/dependency-check.sh \
            --scan . \
            --format HTML \
            --out ../Documentation \
            --disableAssembly --disableNode --disablePython

      # 8. Upload SBOM and Dependency-Check report as artifacts
      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: security-reports
          path: |
            ./password_hygiene_coach/cyclonedx-sbom.json
            ./Documentation/dependency-check-report.html
